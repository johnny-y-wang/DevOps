# Powershell 2.0
# Copyright (c) 2008-2013 RightScale, Inc, All Rights Reserved Worldwide.

$errorActionPreference = "Stop"


$caRSLibPath = $env:CA_GBL_RS_LIB_FILE_PATH
$bucketName = $env:CA_GBL_OPS_BUCKET_NAME
$region = $env:CA_DPL_REGION
$blnEncryptConfig = $env:CA_SA_BOOL_ENCRYPT_CONFIG
$xmlKeys = $env:CA_DPL_CONFIG_ENCRYPTION_KEY
$tierName = $env:CA_SA_TIER_NAME

#Initialize the variables with the credentials which contains the data for external config files and the corresponding external config file names
$connStringsXML = $env:CA_SA_CRED_CONFIG_CONNSTRINGS
$connStringsFileName = "connstrings.config"

$winservicesAppSettingsXML = $env:CA_SA_CRED_CONFIG_APPSETTINGS
$winservicesAppSettingsFileName = "ca-appsettings.config"

#Create a hashtable using the external config file name as the key and file contents coming from credentials as the value
$tblExternalConfig = @{"submission"=@{$winservicesAppSettingsFileName=$winservicesAppSettingsXML;$connStringsFileName=$connStringsXML};
                       "swflargemember"=@{$winservicesAppSettingsFileName=$winservicesAppSettingsXML;$connStringsFileName=$connStringsXML};
                       "swfsmallmember"=@{$winservicesAppSettingsFileName=$winservicesAppSettingsXML;$connStringsFileName=$connStringsXML};
                       "swflargesds"=@{$winservicesAppSettingsFileName=$winservicesAppSettingsXML;$connStringsFileName=$connStringsXML};
                       "accountrollover"=@{$winservicesAppSettingsFileName=$winservicesAppSettingsXML;$connStringsFileName=$connStringsXML}
                       }

#Following variables can contain one more values separated by coma
$arrWinServiceName = $env:CA_SA_ARR_WIN_SERVICE_NAME.split(",")
$arrInstallFolderPath = $env:CA_SA_ARR_INSTALL_FOLDER_PATH.split(",")
$arrConfigFileS3Key = $env:CA_SA_ARR_CONFIG_FILE_S3_KEY.split(",")
$arrAdditionalConfigFileS3Key = $env:CA_SA_ARR_ADD_CONFIG_FILE_S3_KEY.split(",")

$tblInstallFolderPath = @{}
$tblConfigFileS3Key = @{}

# Create hashtables using array containing service properties like installation folder, executable file name and build source folder in the build package
$arrWinServiceName | % {$i=0}{$tblInstallFolderPath.Add($_, $($arrInstallFolderPath[$i]));$i++}
$arrWinServiceName | % {$i=0}{$tblConfigFileS3Key.Add($_, $($arrConfigFileS3Key[$i]));$i++}


#Include the CA RightScale library
. $caRSLibPath

foreach ($winServiceName in $arrWinServiceName) {

  $installFolderPath = $tblInstallFolderPath.Get_Item($winServiceName)
  $configFileS3Key = $tblConfigFileS3Key.Get_Item($winServiceName)
  
  #Create an array for all config files needed for a service, including service.exe.config and any additional channel config files
  $arrServiceConfigFileS3Key = $arrAdditionalConfigFileS3Key
  $arrServiceConfigFileS3Key += $configFileS3Key
  
  "Deploying config file $configFileS3Key from $bucketName to folder $installFolderPath."
  
  DeployConfigFile $region $bucketName $arrServiceConfigFileS3Key $installFolderPath $tierName $tblExternalConfig

  #Encrypt the config file if flag is set
  if ($blnEncryptConfig.ToLower() -eq "true"){
    EncryptTierConfigFiles $installFolderPath $tierName $tblExternalConfig

  }
}
