#!/bin/bash


#CHECKING TO SEE IF THIS IS A REBOOT, IF SO DO NOT INSTALL
if [ -d "/usr/local/openvpn_as" ]
then
  echo "OpenVPN Already Installed, exiting..."
  exit 0
fi

myUserPropDb=$CA_SA_USERPROP_DB

#GET AVAILABLE UPDATES
#should be done automatically by AWS cloud-init command at boot time 
  sudo yum update -y

#MAKE TEMP DIR AND COPY RPM
  sudo mkdir /home/openvpn_as
  sudo cp $RS_ATTACH_DIR/openvpn-as-2.1.12-CentOS7.x86_64.rpm /home/openvpn_as

#INSTALL RPM
  sudo rpm -i /home/openvpn_as/openvpn-as-2.1.12-CentOS7.x86_64.rpm

#SETUP OPENVPN
  sudo cp $RS_ATTACH_DIR/_ovpn-init /usr/local/openvpn_as/bin
  sudo /usr/local/openvpn_as/bin/ovpn-init --ec2 --batch --force
  sudo /usr/local/openvpn_as/scripts/openvpnas_gen_init --distro redhat
  sudo chkconfig --add openvpnas
  sudo chkconfig openvpnas on
  sudo service openvpnas start

#CHANGE DEFAULT USER PASSWORD
  echo '$CA_SA_CRED_OPENVPN_PWD' | sudo passwd openvpn --stdin

#COPIES SYMBOLIC LINKS TO CORRECT LOCATION
  sudo ln -s /sbin/ifconfig /usr/sbin/ifconfig


#COPIES USER DATABASE
  if [ "$CA_SA_COPY_USERS" == True ]
    then
      sudo cp $RS_ATTACH_DIR/$myUserPropDb /usr/local/openvpn_as/etc/db/userprop.db
    else
      echo "Using default user database."
  fi

#UPDATE SERVER TO TLS 1.2 ONLY
  sudo /usr/local/openvpn_as/scripts/sacli --key vpn.server.tls_version_min --value 1.2 ConfigPut

#UPDATE CLIENT TO TLS 1.2 ONLY
  sudo /usr/local/openvpn_as/scripts/sacli --key vpn.client.tls_version_min --value 1.2 ConfigPut

#UPDATE WEB SERVER TO TLS 1.2 ONLY
  sudo /usr/local/openvpn_as/scripts/sacli --key cs.tls_version_min --value 1.2 ConfigPut

#REMOVING WEAK CIPHER SUITES
  sudo /usr/local/openvpn_as/scripts/sacli -k cs.openssl_ciphersuites -v 'HIGH:!DSS:!aNULL@STRENGTH' ConfigPut

#CHANGE HOSTNAME, ROUTE DNS THROUGH VPN AND ADD PROD CIDR, THEN RESTART CONFIG SERVICE
  sudo /usr/local/openvpn_as/scripts/confdba -mk "host.name" -v $CA_SA_VPN_HOSTNAME
  sudo /usr/local/openvpn_as/scripts/confdba -mk "vpn.client.routing.reroute_dns" -v "true"


  #SINCE PRODUCT SUPPORT VPN ACCESS BOTH 10.10 AND 10.1, WE NEED TO PASS IN ANOTHER CIDR IF PS VPN OPTION IS SELECTED
  if [ "$CA_SA_VPN_HOSTNAME" == access.ps.commonapp.net ]
  then
    sudo /usr/local/openvpn_as/scripts/confdba -mk "vpn.server.routing.private_network.1" -v "10.1.0.0/16"
  fi
  
  sudo /usr/local/openvpn_as/scripts/sacli start


#SETS PERMISSIONS ON DATABASE FILE TO ALLOW REMOTE COPY
  sudo chown -R ec2-user /usr/local/openvpn_as/etc/db

#RESTARTS SERVICE
  sudo service openvpnas restart