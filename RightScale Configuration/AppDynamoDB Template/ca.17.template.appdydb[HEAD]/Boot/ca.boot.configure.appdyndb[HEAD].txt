#!/bin/bash

#
# Test for a reboot, if this is a reboot just skip this script.
#


if test "$RS_REBOOT" = "true"
then
  echo "AppDynamic DB agent installed, skipped on a reboot."
  logger -t RightScale "AppDynamic DB agent installed, skipped on a reboot."
  exit 0
fi

myDNSname=$CA_DPL_APDYN_DNS
myHostName=$CA_DPL_APDYN_HOST
ATTACH_DIR=$RS_ATTACH_DIR
myApDynPwd=$CA_DPL_APDYN_PWD

######### python ###########
#python is installed by default, use "python -V" to check
#install boto library
sudo yum install python-pip -y

#Enable epel to install colordiff
sudo yum-config-manager --enable epel
sudo yum -y install colordiff

#Create Linux User "appdyndb" 
#sudo mkdir /opt/appdyndb
sudo useradd -d /opt/appdyndb appdyndb 
sudo sh -c "echo $myApDynPwd | passwd appdyndb"

sudo cp $ATTACH_DIR/bashrc /root/.bashrc
sudo cp $ATTACH_DIR/vimrc /root/.vimrc
sudo cp $ATTACH_DIR/bashrc /home/ec2-user/.bashrc
sudo cp $ATTACH_DIR/vimrc /home/ec2-user/.vimrc
sudo cp $ATTACH_DIR/bashrc /opt/appdyndb/.bashrc
sudo cp $ATTACH_DIR/vimrc /opt/appdyndb/.vimrc
sudo chown ec2-user /home/ec2-user/.bashrc
sudo chown ec2-user /home/ec2-user/.vimrc
sudo chown appdyndb /opt/appdyndb/.bashrc
sudo chown appdyndb /opt/appdyndb/.vimrc

sudo -u appdyndb mkdir /opt/appdyndb/downloads
sudo cp $ATTACH_DIR/*.gz /opt/appdyndb/downloads

#Install Appdynamics for Databse as "appdyndb" user
cd /opt/appdyndb/downloads
sudo -u appdyndb gunzip AppD-Database-Linux64.tar.gz

#Extract the .tar file to /opt/appdyndb folder
sudo tar -C /opt/appdyndb  -xvf AppD-Database-Linux64.tar

#Start Appdynamics for database
#Run the ./start.sh script from the installation directory to start the processes for AppDynamics for Databases.
cd /opt/appdyndb
sudo -u appdyndb ./start.sh
sudo -u appdyndb ./showStatus.sh


#myIP=$(ifconfig eth0 |grep  'inet addr:' | cut -d ':' -f2|cut -d' ' -f1)
#if test x$myIP != x && grep $myDNSname /etc/hosts > /dev/null 2>&1
#then
#    :
#else
#    sudo echo "$myIP  $myDNSname >> /etc/hosts"
#    sudo sh -c "echo $myIP  $myDNSname >> /etc/hosts"
#fi

#add mysql client
sudo yum install mysql -y

#replace/add HOSTname
sudo sed -i "s/MYHOSTNAME/$myHostName/" /root/.bashrc
sudo sed -i "s/MYHOSTNAME/$myHostName/" /home/ec2-user/.bashrc
sudo sed -i "s/HOSTNAME=localhost.localdomain/HOSTNAME=$myHostName/" /etc/sysconfig/network

sudo hostname $myHostName

